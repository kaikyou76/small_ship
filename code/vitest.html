<!DOCTYPE html>
<html lang="ja-JP" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Code coverage report for src/endpoints/auth | Kaikyou の開発ノート</title>
    <meta name="description" content="React / Next.js / Cloudflare D1 を中心にした開発ブログ">
    <meta name="generator" content="VitePress v1.6.3">
    <link rel="preload stylesheet" href="/small_ship/assets/style.Z8IWenJB.css" as="style">
    <link rel="preload stylesheet" href="/small_ship/vp-icons.css" as="style">
    
    <script type="module" src="/small_ship/assets/app.DnCPCkmg.js"></script>
    <link rel="preload" href="/small_ship/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/small_ship/assets/chunks/theme.35Zj05If.js">
    <link rel="modulepreload" href="/small_ship/assets/chunks/framework.4ukD4ZLJ.js">
    <link rel="modulepreload" href="/small_ship/assets/code_vitest.md.CQ_K4J4X.lean.js">
    <style>
        :root {
          --vp-code-block-bg:rgb(236, 251, 221) !important; /* ライトモード背景色 */
        }
        
        .dark {
          --vp-code-block-bg:rgb(38, 7, 38) !important; /* ダークモード背景色（濃いグレー） */
        }
                /* 🌕 全ページ共通の背景色をグレーに設定 */
      body {
        background-color:rgb(248, 227, 152) !important;
      }
              /* 🌙 ダークモード時は黒に */
      .dark body {
        background-color: #0f0f0f !important;
      }
      </style>
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5dedf783><!--[--><!--]--><!--[--><span tabindex="-1" data-v-d3f76cb8></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-d3f76cb8>Skip to content</a><!--]--><!----><header class="VPNav" data-v-5dedf783 data-v-86224537><div class="VPNavBar" data-v-86224537 data-v-822f93c5><div class="wrapper" data-v-822f93c5><div class="container" data-v-822f93c5><div class="title" data-v-822f93c5><div class="VPNavBarTitle has-sidebar" data-v-822f93c5 data-v-9de3f10f><a class="title" href="/small_ship/" data-v-9de3f10f><!--[--><!--]--><!----><span data-v-9de3f10f>Kaikyou の開発ノート</span><!--[--><!--]--></a></div></div><div class="content" data-v-822f93c5><div class="content-body" data-v-822f93c5><!--[--><!--]--><div class="VPNavBarSearch search" data-v-822f93c5><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-822f93c5 data-v-504ba415><span id="main-nav-aria-label" class="visually-hidden" data-v-504ba415> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>🏠 ホーム</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/guide/" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>📚 ガイド</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/tutorial/" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>🛠️ チュートリアル</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/posts/" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>📒 記事一覧</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/about/me.html" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>👤 私について</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/code/" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>📒 設定について</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/small_ship/coment/" tabindex="0" data-v-504ba415 data-v-07909928><!--[--><span data-v-07909928>📒 説明</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-822f93c5 data-v-066d04e2><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-066d04e2 data-v-72c3175f data-v-33603fd2><span class="check" data-v-33603fd2><span class="icon" data-v-33603fd2><!--[--><span class="vpi-sun sun" data-v-72c3175f></span><span class="vpi-moon moon" data-v-72c3175f></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-822f93c5 data-v-ff78c1fc data-v-2469e9df><!--[--><a class="VPSocialLink no-icon" href="https://github.com/your-account" aria-label="github" target="_blank" rel="noopener" data-v-2469e9df data-v-2d7e0877><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-822f93c5 data-v-60be4d3e data-v-85edf446><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-85edf446><span class="vpi-more-horizontal icon" data-v-85edf446></span></button><div class="menu" data-v-85edf446><div class="VPMenu" data-v-85edf446 data-v-f41c61c8><!----><!--[--><!--[--><!----><div class="group" data-v-60be4d3e><div class="item appearance" data-v-60be4d3e><p class="label" data-v-60be4d3e>Appearance</p><div class="appearance-action" data-v-60be4d3e><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-60be4d3e data-v-72c3175f data-v-33603fd2><span class="check" data-v-33603fd2><span class="icon" data-v-33603fd2><!--[--><span class="vpi-sun sun" data-v-72c3175f></span><span class="vpi-moon moon" data-v-72c3175f></span><!--]--></span></span></button></div></div></div><div class="group" data-v-60be4d3e><div class="item social-links" data-v-60be4d3e><div class="VPSocialLinks social-links-list" data-v-60be4d3e data-v-2469e9df><!--[--><a class="VPSocialLink no-icon" href="https://github.com/your-account" aria-label="github" target="_blank" rel="noopener" data-v-2469e9df data-v-2d7e0877><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-822f93c5 data-v-51bd8ab7><span class="container" data-v-51bd8ab7><span class="top" data-v-51bd8ab7></span><span class="middle" data-v-51bd8ab7></span><span class="bottom" data-v-51bd8ab7></span></span></button></div></div></div></div><div class="divider" data-v-822f93c5><div class="divider-line" data-v-822f93c5></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-5dedf783 data-v-baa5c8e0><div class="container" data-v-baa5c8e0><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-baa5c8e0><span class="vpi-align-left menu-icon" data-v-baa5c8e0></span><span class="menu-text" data-v-baa5c8e0>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-baa5c8e0 data-v-2793e769><button data-v-2793e769>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-5dedf783 data-v-07663b60><div class="curtain" data-v-07663b60></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-07663b60><span class="visually-hidden" id="sidebar-aria-label" data-v-07663b60> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-95b46f4a><section class="VPSidebarItem level-0 collapsible" data-v-95b46f4a data-v-5c3613d9><div class="item" role="button" tabindex="0" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><h2 class="text" data-v-5c3613d9>フロントエンド設定</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-5c3613d9><span class="vpi-chevron-right caret-icon" data-v-5c3613d9></span></div></div><div class="items" data-v-5c3613d9><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/kankyou.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>環境変数設定ファイル</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/css.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>Tailwind CSSセットアップ</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-95b46f4a><section class="VPSidebarItem level-0 collapsible has-active" data-v-95b46f4a data-v-5c3613d9><div class="item" role="button" tabindex="0" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><h2 class="text" data-v-5c3613d9>バックエンド設定</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-5c3613d9><span class="vpi-chevron-right caret-icon" data-v-5c3613d9></span></div></div><div class="items" data-v-5c3613d9><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/setting.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>（Cloudflare Workers）設定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/bk_kankyou.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>環境変数設定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/route.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>バックエンドルート設定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/jesttest.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>テスト環境の設定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/vitest.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>Vitestテスト環境の設定</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-95b46f4a><section class="VPSidebarItem level-0 collapsible" data-v-95b46f4a data-v-5c3613d9><div class="item" role="button" tabindex="0" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><h2 class="text" data-v-5c3613d9>プロジェクト設定</h2><div class="caret" role="button" aria-label="toggle section" tabindex="0" data-v-5c3613d9><span class="vpi-chevron-right caret-icon" data-v-5c3613d9></span></div></div><div class="items" data-v-5c3613d9><!--[--><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/anzen.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>.gitignore設定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/deburoi.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>修正内容デプロイ手順</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/v_kankyou.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>Vercel環境変数設定</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/github_set.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>githubセットアップ</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-5c3613d9 data-v-5c3613d9><div class="item" data-v-5c3613d9><div class="indicator" data-v-5c3613d9></div><a class="VPLink link link" href="/small_ship/code/github.html" data-v-5c3613d9><!--[--><p class="text" data-v-5c3613d9>壊れた環境の復元</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5dedf783 data-v-1a68976b><div class="VPDoc has-sidebar has-aside" data-v-1a68976b data-v-ae40fa06><!--[--><!--]--><div class="container" data-v-ae40fa06><div class="aside" data-v-ae40fa06><div class="aside-curtain" data-v-ae40fa06></div><div class="aside-container" data-v-ae40fa06><div class="aside-content" data-v-ae40fa06><div class="VPDocAside" data-v-ae40fa06 data-v-cf4b1efb><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-cf4b1efb data-v-6626f076><div class="content" data-v-6626f076><div class="outline-marker" data-v-6626f076></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-6626f076>On this page</div><ul class="VPDocOutlineItem root" data-v-6626f076 data-v-268fa04c><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-cf4b1efb></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-ae40fa06><div class="content-container" data-v-ae40fa06><!--[--><!--]--><main class="main" data-v-ae40fa06><div style="position:relative;" class="vp-doc _small_ship_code_vitest" data-v-ae40fa06><div><p>以下は、提供された公式ドキュメントに基づいて、<strong>Vitest</strong>と<strong>Cloudflare Workers</strong>のテスト環境を構築する手順です。このガイドでは、Vitest を使用して Cloudflare Workers のユニットテストと統合テストを実行する方法を説明します。</p><hr><h2 id="_1-必要なパッケージのインストール" tabindex="-1">1. 必要なパッケージのインストール <a class="header-anchor" href="#_1-必要なパッケージのインストール" aria-label="Permalink to &quot;1. 必要なパッケージのインストール&quot;">​</a></h2><p>まず、必要なパッケージをインストールします。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">npm</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#C3E88D;"> --save-dev</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> vitest</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> @cloudflare/vitest-pool-workers</span></span></code></pre></div><hr><h2 id="_2-vitest-config-tsの設定" tabindex="-1">2. <code>vitest.config.ts</code>の設定 <a class="header-anchor" href="#_2-vitest-config-tsの設定" aria-label="Permalink to &quot;2. `vitest.config.ts`の設定&quot;">​</a></h2><p>Vitest の設定ファイルを作成し、Cloudflare Workers 用の設定を追加します。</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// vitest.config.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> defineWorkersConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">@cloudflare/vitest-pool-workers/config</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">export</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> defineWorkersConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  test</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    poolOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      workers</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        wrangler</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> configPath</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">./wrangler.toml</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> },</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // Wranglerの設定ファイルを指定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        miniflare</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          kvNamespaces</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">TEST_NAMESPACE</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // テスト用のKVネームスペースを追加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><hr><h2 id="_3-wrangler-の設定" tabindex="-1">3. Wrangler の設定 <a class="header-anchor" href="#_3-wrangler-の設定" aria-label="Permalink to &quot;3. Wrangler の設定&quot;">​</a></h2><p><code>wrangler.toml</code>ファイルを作成し、Cloudflare Workers の設定を記述します。</p><div class="language-toml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">toml</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"># wrangler.toml</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">name </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">my-worker</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">main </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">src/index.js</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">compatibility_date </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">2023-10-01</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">kv_namespaces </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> [</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> binding </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">TEST_NAMESPACE</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> id </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-namespace-id</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">]</span></span></code></pre></div><hr><h2 id="_4-型定義の設定" tabindex="-1">4. 型定義の設定 <a class="header-anchor" href="#_4-型定義の設定" aria-label="Permalink to &quot;4. 型定義の設定&quot;">​</a></h2><p>TypeScript を使用している場合、型定義を設定します。</p><h3 id="_1-wrangler-typesを実行" tabindex="-1">(1) <code>wrangler types</code>を実行 <a class="header-anchor" href="#_1-wrangler-typesを実行" aria-label="Permalink to &quot;(1) `wrangler types`を実行&quot;">​</a></h3><p>Cloudflare Workers の型定義を生成します。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> wrangler</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> types</span></span></code></pre></div><p>これにより、<code>src/worker-configuration.d.ts</code>が生成されます。</p><hr><h3 id="_2-tsconfig-jsonの設定" tabindex="-1">(2) <code>tsconfig.json</code>の設定 <a class="header-anchor" href="#_2-tsconfig-jsonの設定" aria-label="Permalink to &quot;(2) `tsconfig.json`の設定&quot;">​</a></h3><p>テスト用の<code>tsconfig.json</code>を作成し、型定義を追加します。</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// test/tsconfig.json</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#C792EA;">extends</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../tsconfig.json</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#C792EA;">compilerOptions</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;">moduleResolution</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">bundler</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;">types</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">@cloudflare/vitest-pool-workers</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // `cloudflare:test`の型を提供</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#C792EA;">include</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> [</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">./**/*.ts</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../src/worker-configuration.d.ts</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // `wrangler types`の出力を追加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  ]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><hr><h3 id="_3-env-d-tsの設定" tabindex="-1">(3) <code>env.d.ts</code>の設定 <a class="header-anchor" href="#_3-env-d-tsの設定" aria-label="Permalink to &quot;(3) `env.d.ts`の設定&quot;">​</a></h3><p>テスト用の<code>env.d.ts</code>を作成し、<code>ProvidedEnv</code>インターフェースを定義します。</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// test/env.d.ts</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">/// </span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">&lt;</span><span style="--shiki-light:#22863A;--shiki-light-font-style:inherit;--shiki-dark:#F07178;--shiki-dark-font-style:italic;">reference</span><span style="--shiki-light:#6F42C1;--shiki-light-font-style:inherit;--shiki-dark:#C792EA;--shiki-dark-font-style:italic;"> path</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">=</span><span style="--shiki-light:#032F62;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">&quot;</span><span style="--shiki-light:#032F62;--shiki-light-font-style:inherit;--shiki-dark:#C3E88D;--shiki-dark-font-style:italic;">../src/worker-configuration.d.ts</span><span style="--shiki-light:#032F62;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">&quot;</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> /&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">declare</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> module</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">cloudflare:test</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // ProvidedEnvは`import(&quot;cloudflare:test&quot;).env`の型を制御</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  interface</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ProvidedEnv</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><hr><h2 id="_5-worker-の実装" tabindex="-1">5. Worker の実装 <a class="header-anchor" href="#_5-worker-の実装" aria-label="Permalink to &quot;5. Worker の実装&quot;">​</a></h2><p>簡単な Worker を実装します。</p><div class="language-javascript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// src/index.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">export</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> default</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  async</span><span style="--shiki-light:#6F42C1;--shiki-dark:#F07178;"> fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">(</span><span style="--shiki-light:#E36209;--shiki-light-font-style:inherit;--shiki-dark:#EEFFFF;--shiki-dark-font-style:italic;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#E36209;--shiki-light-font-style:inherit;--shiki-dark:#EEFFFF;--shiki-dark-font-style:italic;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#E36209;--shiki-light-font-style:inherit;--shiki-dark:#EEFFFF;--shiki-dark-font-style:italic;"> ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> url</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> URL</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">url</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">pathname</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> ===</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">/404</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">      return</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Not found</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> status</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;"> 404</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> Response</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Hello World!</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">};</span></span></code></pre></div><hr><h2 id="_6-ユニットテストの作成" tabindex="-1">6. ユニットテストの作成 <a class="header-anchor" href="#_6-ユニットテストの作成" aria-label="Permalink to &quot;6. ユニットテストの作成&quot;">​</a></h2><p>Vitest を使用して、Worker のユニットテストを作成します。</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// test/unit.spec.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  createExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  waitOnExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">cloudflare:test</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> describe</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> it</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> expect</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">vitest</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../src/index.js</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> IncomingRequest</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> Request</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">describe</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Hello World worker</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">responds with Hello World!</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> request</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> IncomingRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">http://example.com/</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> createExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> waitOnExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Hello World!</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">responds with not found for /404</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> request</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> IncomingRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">http://example.com/404</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> ctx</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> createExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">request</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> waitOnExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">ctx</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">404</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Not found</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><hr><h2 id="_7-統合テストの作成" tabindex="-1">7. 統合テストの作成 <a class="header-anchor" href="#_7-統合テストの作成" aria-label="Permalink to &quot;7. 統合テストの作成&quot;">​</a></h2><p><code>SELF</code>フェッチャーを使用して、統合テストを作成します。</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// test/integration.spec.js</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> SELF</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">cloudflare:test</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> describe</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> it</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> expect</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">vitest</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">describe</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Hello World worker</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">responds with Hello World!</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> SELF</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">http://example.com/</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Hello World!</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">responds with not found for /404</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> SELF</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">http://example.com/404</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">404</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">text</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">())</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Not found</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><hr><h2 id="_8-テストの実行" tabindex="-1">8. テストの実行 <a class="header-anchor" href="#_8-テストの実行" aria-label="Permalink to &quot;8. テストの実行&quot;">​</a></h2><p>以下のコマンドでテストを実行します。</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> vitest</span></span></code></pre></div><hr><h2 id="_9-テスト結果の確認" tabindex="-1">9. テスト結果の確認 <a class="header-anchor" href="#_9-テスト結果の確認" aria-label="Permalink to &quot;9. テスト結果の確認&quot;">​</a></h2><p>テストが正常に実行されると、以下のような結果が表示されます。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span>✓ test/unit.spec.js (2)</span></span>
<span class="line"><span>✓ test/integration.spec.js (2)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Test Files  2 passed (2)</span></span>
<span class="line"><span>     Tests  4 passed (4)</span></span></code></pre></div><hr><h2 id="まとめ" tabindex="-1">まとめ <a class="header-anchor" href="#まとめ" aria-label="Permalink to &quot;まとめ&quot;">​</a></h2><p>このガイドでは、Vitest と Cloudflare Workers を使用して、ユニットテストと統合テストを実行する方法を説明しました。以下の手順を実行しました：</p><ol><li>必要なパッケージのインストール</li><li><code>vitest.config.ts</code>の設定</li><li>Wrangler の設定</li><li>型定義の設定</li><li>Worker の実装</li><li>ユニットテストの作成</li><li>統合テストの作成</li><li>テストの実行</li></ol><p>これで、Cloudflare Workers のテスト環境が構築されました。さらに複雑なテストや設定が必要な場合は、<a href="https://developers.cloudflare.com/workers/testing/vitest-integration/" target="_blank" rel="noreferrer">公式ドキュメント</a>を参照してください。</p><p>これはテストの <strong>カバレッジレポート</strong>（code coverage report）で使われる項目です。各項目の意味は以下の通りです：</p><table tabindex="0"><thead><tr><th>項目名</th><th>意味</th></tr></thead><tbody><tr><td><code>File</code></td><td>各行に対応する<strong>ファイル名</strong>（テスト対象のコードファイル）です。</td></tr><tr><td><code>% Stmts</code></td><td><strong>ステートメント（文）全体のカバレッジ率</strong>：<code>if</code> 文や関数呼び出しなど、全てのコード文のうち、テストで実行された割合。例：100 行中 90 行が実行 → 90%。</td></tr><tr><td><code>% Branch</code></td><td><strong>分岐のカバレッジ率</strong>：<code>if/else</code> や <code>switch</code> の分岐のうち、すべてのパス（条件）がテストされた割合。例：<code>if (x &gt; 0)</code> の <code>true</code> と <code>false</code> の両方が通ったか。</td></tr><tr><td><code>% Funcs</code></td><td><strong>関数のカバレッジ率</strong>：定義された関数・メソッドのうち、テストで呼び出された割合。</td></tr><tr><td><code>% Lines</code></td><td><strong>コード行のカバレッジ率</strong>：<code>% Stmts</code> と似ているが、実行された行ベースでカウント（コメントなどを除くコード行）。</td></tr><tr><td><code>Uncovered Line #s</code></td><td><strong>テストで実行されなかった行番号のリスト</strong>。この行のコードはテストでカバーされていない。カバレッジ向上のために注目するポイント。</td></tr></tbody></table><hr><p>たとえば以下のように表示されていたら：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span>File         | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s</span></span>
<span class="line"><span>-------------|---------|----------|---------|---------|-------------------</span></span>
<span class="line"><span>login.ts     | 95.00   | 75.00    | 100.00  | 95.00   | 42, 57</span></span></code></pre></div><p>これは：</p><ul><li><code>login.ts</code> の文（statement）の 95%、関数の 100%、コード行の 95%がテストで実行された。</li><li>ただし分岐のカバー率は 75%で、条件分岐の一部が通っていない。</li><li>行番号 42 番と 57 番のコードはテストで実行されていない。</li></ul><p>という意味です。</p><hr><p>さらに詳しいカバレッジレポート（どの関数や条件が未実行か）を見たい場合は、<code>coverage/lcov-report/index.html</code> をブラウザで開くとグラフィカルに確認できます。</p><p>必要なら、特定ファイルの「なぜこの行がカバーされていないか」を一緒に調査できますか？</p><p>% Coverage report from istanbul --------------------|---------|----------|---------|---------|----------------------</p><table tabindex="0"><thead><tr><th>File</th><th>% Stmts</th><th>% Branch</th><th>% Funcs</th><th>% Lines</th><th>Uncovered Line #s</th></tr></thead><tbody><tr><td>All files</td><td>17.55</td><td>6.25</td><td>4.54</td><td>17.84</td><td></td></tr><tr><td>src</td><td>28.57</td><td>100</td><td>25</td><td>28.57</td><td></td></tr><tr><td>index.js</td><td>0</td><td>100</td><td>0</td><td>0</td><td>3-12</td></tr><tr><td>worker.ts</td><td>100</td><td>100</td><td>50</td><td>100</td><td></td></tr><tr><td>src/endpoints</td><td>8.1</td><td>0</td><td>0</td><td>8.1</td><td></td></tr><tr><td>getCart.ts</td><td>9.37</td><td>0</td><td>0</td><td>9.37</td><td>12-32,55-67,106-180</td></tr><tr><td>productCreate.ts</td><td>4</td><td>0</td><td>0</td><td>4</td><td>10-124</td></tr><tr><td>productGet.ts</td><td>14.28</td><td>100</td><td>0</td><td>14.28</td><td>9-15</td></tr><tr><td>productGetById.ts</td><td>10</td><td>0</td><td>0</td><td>10</td><td>11-29</td></tr><tr><td>src/endpoints/auth</td><td>35.71</td><td>33.33</td><td>25</td><td>35.71</td><td></td></tr><tr><td>getUser.ts</td><td>9.09</td><td>0</td><td>0</td><td>9.09</td><td>13-65</td></tr><tr><td>login.ts</td><td>88.88</td><td>100</td><td>100</td><td>88.88</td><td>91-92</td></tr><tr><td>logout.ts</td><td>11.11</td><td>0</td><td>0</td><td>11.11</td><td>8-22</td></tr><tr><td>register.ts</td><td>11.11</td><td>0</td><td>0</td><td>11.11</td><td>16-79</td></tr><tr><td>src/lib</td><td>6.45</td><td>0</td><td>0</td><td>6.89</td><td></td></tr><tr><td>auth.ts</td><td>0</td><td>0</td><td>0</td><td>0</td><td>12-88</td></tr><tr><td>storage.ts</td><td>22.22</td><td>0</td><td>0</td><td>22.22</td><td>16-26,37-38</td></tr><tr><td>src/middleware</td><td>3.92</td><td>0</td><td>0</td><td>4.08</td><td></td></tr><tr><td>jwt.ts</td><td>3.92</td><td>0</td><td>0</td><td>4.08</td><td>38-133,145-201</td></tr><tr><td>src/routes</td><td>55.55</td><td>0</td><td>0</td><td>55.55</td><td></td></tr><tr><td>index.ts</td><td>55.55</td><td>0</td><td>0</td><td>55.55</td><td>39-42,62,75,85,89-90</td></tr><tr><td>src/schemas</td><td>14.28</td><td>0</td><td>0</td><td>14.28</td><td></td></tr><tr><td>product.ts</td><td>14.28</td><td>0</td><td>0</td><td>14.28</td><td>7-37</td></tr><tr><td>src/types</td><td>0</td><td>100</td><td>100</td><td>0</td><td></td></tr><tr><td>types.ts</td><td>0</td><td>100</td><td>100</td><td>0</td><td>7</td></tr><tr><td>--------------------</td><td>---------</td><td>----------</td><td>---------</td><td>---------</td><td>----------------------</td></tr><tr><td>[vpw:dbg] Shutting down runtimes...</td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>PS D:\next-projects\kaikyou-shop\backend&gt;</td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>阿保、お前の設定はまた忘れたのか！！！！！！！！！ coverage: { reporter: [&quot;text&quot;, &quot;json&quot;, &quot;lcov&quot;], // カバレッジ報告の形式を指定 provider: &quot;istanbul&quot;, // V8 の代わりに Istanbul を使用 }, }, });</p><p>なるほど、そうでしたね！あなたのプロジェクトでは <strong><code>provider: &quot;istanbul&quot;</code> を指定して Vitest 組み込みの Istanbul カバレッジ</strong>を使っていたのでした。完全に記憶ミスでした、申し訳ない。</p><p>それなら、<strong>以下の手順でカバレッジレポートのファイルを生成できます</strong>。</p><hr><h2 id="✅-provider-istanbul-を使ったカバレッジ出力方法" tabindex="-1">✅ <code>provider: &quot;istanbul&quot;</code> を使ったカバレッジ出力方法 <a class="header-anchor" href="#✅-provider-istanbul-を使ったカバレッジ出力方法" aria-label="Permalink to &quot;✅ `provider: &quot;istanbul&quot;` を使ったカバレッジ出力方法&quot;">​</a></h2><h3 id="_1-vitest-config-ts-すでにこうなってる前提" tabindex="-1">1. <code>vitest.config.ts</code>（すでにこうなってる前提） <a class="header-anchor" href="#_1-vitest-config-ts-すでにこうなってる前提" aria-label="Permalink to &quot;1. `vitest.config.ts`（すでにこうなってる前提）&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">vitest/config</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">export</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> defineConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  test</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    coverage</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      provider</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">istanbul</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // ←これ重要！</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      reporter</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">text</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">json</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">lcov</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // ← HTMLは含まれてないけど追加可能</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      reportsDirectory</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">coverage</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // デフォルトでも coverage/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><hr><h3 id="_2-テスト実行時にカバレッジ付きで実行" tabindex="-1">2. テスト実行時にカバレッジ付きで実行 <a class="header-anchor" href="#_2-テスト実行時にカバレッジ付きで実行" aria-label="Permalink to &quot;2. テスト実行時にカバレッジ付きで実行&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">npx</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> vitest</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> run</span><span style="--shiki-light:#005CC5;--shiki-dark:#C3E88D;"> --coverage</span></span></code></pre></div><p>または、<code>package.json</code> にスクリプト追加：</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">scripts</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">: </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#C792EA;">test</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">vitest</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#C792EA;">coverage</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">vitest run --coverage</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><hr><h3 id="_3-出力されるレポート" tabindex="-1">3. 出力されるレポート <a class="header-anchor" href="#_3-出力されるレポート" aria-label="Permalink to &quot;3. 出力されるレポート&quot;">​</a></h3><p>この設定で以下が <code>coverage/</code> フォルダに出力されます：</p><ul><li><code>coverage/lcov-report/index.html</code> ← HTML 形式でブラウザ閲覧 OK！</li><li><code>coverage/coverage-final.json</code></li><li><code>coverage/lcov.info</code></li><li>ターミナルにも text 出力</li></ul><hr><h3 id="✅-ブラウザで確認するには" tabindex="-1">✅ ブラウザで確認するには <a class="header-anchor" href="#✅-ブラウザで確認するには" aria-label="Permalink to &quot;✅ ブラウザで確認するには&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">open</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> coverage/lcov-report/index.html</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> # macOS</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"># または</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">start</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;"> coverage/lcov-report/index.html</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> # Windows</span></span></code></pre></div><hr><h3 id="🔁-忘れずに-gitignore-に追加" tabindex="-1">🔁 忘れずに <code>.gitignore</code> に追加： <a class="header-anchor" href="#🔁-忘れずに-gitignore-に追加" aria-label="Permalink to &quot;🔁 忘れずに `.gitignore` に追加：&quot;">​</a></h3><div class="language-gitignore vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">gitignore</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span>/coverage</span></span></code></pre></div><hr><p>これで Istanbul を使った Vitest のカバレッジレポートが完璧にファイルとして出力されます。 その他、<code>text-summary</code> や <code>cobertura</code> 形式も追加できます。</p><hr><p>何か特定の形式（CI 用 XML とか）で出力したい？</p><p>この設定ファイルは、Cloudflare Workers 環境で Vitest を使用してテストを実行し、カバレッジレポートを生成するための適切な設定を行っています。全体として問題はなく、適切に設定されていますが、いくつか補足説明を加えます。</p><h3 id="設定ファイルの詳細" tabindex="-1">設定ファイルの詳細 <a class="header-anchor" href="#設定ファイルの詳細" aria-label="Permalink to &quot;設定ファイルの詳細&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> defineWorkersConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">@cloudflare/vitest-pool-workers/config</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">export</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> default</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> defineWorkersConfig</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  test</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    poolOptions</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      workers</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        wrangler</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> configPath</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">./wrangler.jsonc</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> },</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // Wranglerの設定ファイルを指定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        miniflare</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          kvNamespaces</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">TEST_NAMESPACE</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // テスト用のKVネームスペースを追加</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    coverage</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      reporter</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> [</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">text</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">json</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">lcov</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">html</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">]</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // カバレッジ報告の形式を指定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      provider</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">istanbul</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // V8の代わりにIstanbulを使用</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      reportsDirectory</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">coverage</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // デフォルトでも coverage/</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><h3 id="主なポイント" tabindex="-1">主なポイント <a class="header-anchor" href="#主なポイント" aria-label="Permalink to &quot;主なポイント&quot;">​</a></h3><ol><li><p><strong>Wrangler 設定の指定</strong>:</p><ul><li><code>wrangler: { configPath: &quot;./wrangler.jsonc&quot; }</code> で、Cloudflare Workers 用の Wrangler 設定ファイル (<code>wrangler.jsonc</code>) を指定しています。これにより、テスト環境でも Wrangler 設定が使用されます。</li></ul></li><li><p><strong>Miniflare 設定</strong>:</p><ul><li><code>miniflare</code> でテスト用の KV ネームスペースを指定しています。これにより、Miniflare のテスト実行中に <code>TEST_NAMESPACE</code> という KV ネームスペースを使用できます。</li></ul></li><li><p><strong>カバレッジレポート</strong>:</p><ul><li><code>coverage: { reporter: [&quot;text&quot;, &quot;json&quot;, &quot;lcov&quot;, &quot;html&quot;], provider: &quot;istanbul&quot;, reportsDirectory: &quot;coverage&quot; }</code> はカバレッジレポートの設定です。ここで <code>istanbul</code> を指定し、レポート形式として <code>text</code>, <code>json</code>, <code>lcov</code>, <code>html</code> を指定しています。これにより、テスト実行後に多様な形式でカバレッジレポートを出力できます。</li><li>出力先のディレクトリは <code>coverage</code> となっており、カバレッジレポートはこのディレクトリに生成されます。</li></ul></li></ol><h3 id="特に注意すべき点" tabindex="-1">特に注意すべき点 <a class="header-anchor" href="#特に注意すべき点" aria-label="Permalink to &quot;特に注意すべき点&quot;">​</a></h3><ul><li><p><strong><code>wrangler.jsonc</code> と <code>miniflare</code> の設定</strong>:</p><ul><li>この設定ファイルは、Cloudflare Workers のローカルテスト環境に依存しています。特に <code>wrangler.jsonc</code> が存在し、Miniflare が設定されている場合、この設定はローカル開発環境に合わせて最適化されます。これらが適切に設定されていることを確認してください。</li></ul></li><li><p><strong>カバレッジレポート形式</strong>:</p><ul><li>レポート形式 (<code>text</code>, <code>json</code>, <code>lcov</code>, <code>html</code>) は好みによりますが、特に <code>html</code> レポートを使うことでブラウザでカバレッジの詳細を視覚的に確認できるため便利です。</li></ul></li><li><p><strong>KV ネームスペース</strong>:</p><ul><li><code>kvNamespaces: [&quot;TEST_NAMESPACE&quot;]</code> で、テスト実行時に使用する Cloudflare Workers KV ネームスペースを指定しています。この名前空間が実際に Cloudflare Workers のアカウントに存在することを確認してください。</li></ul></li></ul><h3 id="結論" tabindex="-1">結論 <a class="header-anchor" href="#結論" aria-label="Permalink to &quot;結論&quot;">​</a></h3><p>この設定ファイルは、Cloudflare Workers 上で Vitest を使ってテストを実行し、カバレッジレポートを生成するために適切に構成されています。設定内容に特に問題はなく、実際のプロジェクトの環境に合わせて必要な部分（特に KV ネームスペースや Wrangler 設定ファイルなど）を調整すれば、テストが正常に実行されるでしょう。</p><p>以下は、提示された HTML の内容を Markdown 形式に変換したものです（視覚情報を表にして表現しています）：</p><hr><h1 id="code-coverage-report-for-src-endpoints-auth" tabindex="-1">Code coverage report for <code>src/endpoints/auth</code> <a class="header-anchor" href="#code-coverage-report-for-src-endpoints-auth" aria-label="Permalink to &quot;Code coverage report for `src/endpoints/auth`&quot;">​</a></h1><p><strong>Statements:</strong> 35.71% (20/56) <strong>Branches:</strong> 33.33% (6/18) <strong>Functions:</strong> 25% (1/4) <strong>Lines:</strong> 35.71% (20/56)</p><blockquote><p><em>Press</em> <code>n</code> <em>or</em> <code>j</code> <em>to go to the next uncovered block, and</em> <code>b</code>, <code>p</code>, <em>or</em> <code>k</code> <em>for the previous block.</em></p></blockquote><h2 id="coverage-summary" tabindex="-1">Coverage Summary <a class="header-anchor" href="#coverage-summary" aria-label="Permalink to &quot;Coverage Summary&quot;">​</a></h2><table tabindex="0"><thead><tr><th>File</th><th>Statements</th><th>Covered</th><th>Branches</th><th>Covered</th><th>Functions</th><th>Covered</th><th>Lines</th><th>Covered</th></tr></thead><tbody><tr><td><a href="./getUser.ts.html">getUser.ts</a></td><td>9.09%</td><td>1/11</td><td>0%</td><td>0/4</td><td>0%</td><td>0/1</td><td>9.09%</td><td>1/11</td></tr><tr><td><a href="./login.ts.html">login.ts</a></td><td>88.88%</td><td>16/18</td><td>100%</td><td>6/6</td><td>100%</td><td>1/1</td><td>88.88%</td><td>16/18</td></tr><tr><td><a href="./logout.ts.html">logout.ts</a></td><td>11.11%</td><td>1/9</td><td>0%</td><td>0/2</td><td>0%</td><td>0/1</td><td>11.11%</td><td>1/9</td></tr><tr><td><a href="./register.ts.html">register.ts</a></td><td>11.11%</td><td>2/18</td><td>0%</td><td>0/6</td><td>0%</td><td>0/1</td><td>11.11%</td><td>2/18</td></tr></tbody></table><hr><p><strong>Code coverage generated by <a href="https://istanbul.js.org/" target="_blank" rel="noreferrer">Istanbul</a></strong><code>2025-05-05T18:41:49.690Z</code></p><hr><p>必要に応じて、装飾や色付きのバッジ形式にもできますが、これはプレーンな Markdown 表現です。表を画像としても提示可能ですが、必要ですか？</p><p>以下は、元の HTML の内容を Markdown 形式に変換し、色付きバッジや表形式の装飾を適用したものです（GitHub Flavored Markdown に準拠）。 HTML のカバレッジレポートを、視覚的に分かりやすく再現しています。</p><hr><h1 id="📊-code-coverage-report-for-src-endpoints-auth" tabindex="-1">📊 Code Coverage Report for <code>src/endpoints/auth</code> <a class="header-anchor" href="#📊-code-coverage-report-for-src-endpoints-auth" aria-label="Permalink to &quot;📊 Code Coverage Report for `src/endpoints/auth`&quot;">​</a></h1><p><a href="./index.html">← All files</a></p><table tabindex="0"><thead><tr><th>✅ カバレッジ項目</th><th>値</th><th>割合</th><th>バッジ</th></tr></thead><tbody><tr><td>Statements</td><td>20/56</td><td><strong>35.71%</strong></td><td><img src="https://img.shields.io/badge/statements-35.71%25-red" alt=""></td></tr><tr><td>Branches</td><td>6/18</td><td><strong>33.33%</strong></td><td><img src="https://img.shields.io/badge/branches-33.33%25-red" alt=""></td></tr><tr><td>Functions</td><td>1/4</td><td><strong>25.00%</strong></td><td><img src="https://img.shields.io/badge/functions-25.00%25-red" alt=""></td></tr><tr><td>Lines</td><td>20/56</td><td><strong>35.71%</strong></td><td><img src="https://img.shields.io/badge/lines-35.71%25-red" alt=""></td></tr></tbody></table><p>🧭 <em>Press <code>n</code> or <code>j</code> to go to the next uncovered block, <code>b</code>, <code>p</code>, or <code>k</code> for the previous block.</em></p><hr><h2 id="📁-coverage-by-file" tabindex="-1">📁 Coverage by File <a class="header-anchor" href="#📁-coverage-by-file" aria-label="Permalink to &quot;📁 Coverage by File&quot;">​</a></h2><table tabindex="0"><thead><tr><th>File</th><th>Statements</th><th>Branches</th><th>Functions</th><th>Lines</th></tr></thead><tbody><tr><td><a href="./getUser.ts.html"><code>getUser.ts</code></a></td><td><img src="https://img.shields.io/badge/9.09%25-red" alt=""> (1/11)</td><td><img src="https://img.shields.io/badge/0%25-red" alt=""> (0/4)</td><td><img src="https://img.shields.io/badge/0%25-red" alt=""> (0/1)</td><td><img src="https://img.shields.io/badge/9.09%25-red" alt=""> (1/11)</td></tr><tr><td><a href="./login.ts.html"><code>login.ts</code></a></td><td><img src="https://img.shields.io/badge/88.88%25-brightgreen" alt=""> (16/18)</td><td><img src="https://img.shields.io/badge/100%25-brightgreen" alt=""> (6/6)</td><td><img src="https://img.shields.io/badge/100%25-brightgreen" alt=""> (1/1)</td><td><img src="https://img.shields.io/badge/88.88%25-brightgreen" alt=""> (16/18)</td></tr><tr><td><a href="./logout.ts.html"><code>logout.ts</code></a></td><td><img src="https://img.shields.io/badge/11.11%25-red" alt=""> (1/9)</td><td><img src="https://img.shields.io/badge/0%25-red" alt=""> (0/2)</td><td><img src="https://img.shields.io/badge/0%25-red" alt=""> (0/1)</td><td><img src="https://img.shields.io/badge/11.11%25-red" alt=""> (1/9)</td></tr><tr><td><a href="./register.ts.html"><code>register.ts</code></a></td><td><img src="https://img.shields.io/badge/11.11%25-red" alt=""> (2/18)</td><td><img src="https://img.shields.io/badge/0%25-red" alt=""> (0/6)</td><td><img src="https://img.shields.io/badge/0%25-red" alt=""> (0/1)</td><td><img src="https://img.shields.io/badge/11.11%25-red" alt=""> (2/18)</td></tr></tbody></table><hr><p>📅 Generated by <a href="https://istanbul.js.org/" target="_blank" rel="noreferrer">Istanbul</a> on <strong>2025-05-05T18:41:49.690Z</strong></p><hr><p>※ 注：上記バッジ画像は GitHub の README 等でのみ表示されます。 ローカル Markdown ビューアでは正しく表示されない場合があります。</p><hr><p>何か特定のフォーマット（例えば Notion や Obsidian 用など）に最適化したい場合も対応できます。どこで使う予定ですか？</p><p>⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯ 👑 ❓✨❌🥇🥈🥉🛠📊⚙️ 🧪🧠🔧✔✅🚫🔍🧭 🧱 具体的に login.test.ts がどのように login.ts にあわせてテスト確認するのか？その処理ごとにご説明ください</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// backend/test/login.test.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> describe</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> it</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> expect</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> beforeEach</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">vitest</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../src/worker</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // worker.ts からインポート</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> Env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../src/types/types</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> createRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">./utils/createRequest</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">@cloudflare/workers-types</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;"> *</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> authUtils </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../src/lib/auth</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // auth.ts からインポート</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> LoginSuccessResponse</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">  data</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    token</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    user</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">      id</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">      name</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">      email</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">      role</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">  error</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    code</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    message</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  };</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">describe</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">POST /api/login</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test@example.com</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    password_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">hashedpw</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Test User</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">user</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  let</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  beforeEach</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">    vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">restoreAllMocks</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // モック環境を設定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">    env</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      ENVIRONMENT</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          bind</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">          }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      JWT_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-secret</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      JWT_ISSUER</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-issuer</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      JWT_AUDIENCE</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-audience</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> unknown</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // モック関数を設定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">    vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">authUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">verifyPassword</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#FF9CAC;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">    vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">authUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">generateAuthToken</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">mocked-jwt</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // リクエストを作成するヘルパー関数</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#EEFFFF;"> makeRequest</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#E36209;--shiki-light-font-style:inherit;--shiki-dark:#EEFFFF;--shiki-dark-font-style:italic;">body</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> object</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    createRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">http://localhost/api/login</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      method</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">POST</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      body</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">body</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      headers</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#F07178;">Content-Type</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">application/json</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // 正常系: ログイン成功</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン成功時にJWTとユーザー情報を返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">password123</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> LoginSuccessResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ステータスコードとレスポンスを検証</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">token</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">mocked-jwt</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toEqual</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // 異常系: パスワードが間違っている</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">パスワードが間違っている場合、401エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">    vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">authUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">verifyPassword</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#FF9CAC;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">wrongpassword</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ステータスコードとエラーメッセージを検証</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // 異常系: ユーザーが存在しない</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ユーザーが存在しない場合、401エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ユーザーが見つからないようにモックを設定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    (</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">prepare</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      bind</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">no-user@example.com</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">whatever</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ステータスコードとエラーメッセージを検証</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // 異常系: バリデーションエラー（emailなし）</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">emailが入力されていない場合、400エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">password123</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ステータスコードとエラーメッセージを検証</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">400</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">VALIDATION_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスとパスワードを正しく入力してください</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // 異常系: 内部サーバーエラー</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  it</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">DBクエリが失敗した場合、500エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // DBクエリが失敗するようにモックを設定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    (</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">prepare</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      bind</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockRejectedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Database error</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">password123</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ステータスコードとエラーメッセージを検証</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INTERNAL_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">    expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン処理に失敗しました</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// backend/src/endpoints/auth/login.ts</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> Context</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">hono</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> Bindings</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> SuccessResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../../types/types</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> generateAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> verifyPassword</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">../../lib/auth</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> from</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">zod</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> loginSchema</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">object</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> z</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">min</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">export</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#EEFFFF;"> loginHandler</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> (</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-light-font-style:inherit;--shiki-dark:#EEFFFF;--shiki-dark-font-style:italic;">  c</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Context</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">&lt;{</span><span style="--shiki-light:#E36209;--shiki-dark:#F07178;"> Bindings</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Bindings</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;">Response</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">  try</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> rawJson</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> validationResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> loginSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">safeParse</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">rawJson</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">validationResult</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">success</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">VALIDATION_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスとパスワードを正しく入力してください</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">          },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> satisfies</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">        400</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> validationResult</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // ユーザー取得</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">      &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">SELECT id, email, password_hash, name, role FROM users WHERE email = ?</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">&lt;{</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">        id</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">        email</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">        password_hash</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">        name</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">        role</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      }&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">          },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> satisfies</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">        401</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // パスワード検証</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> isValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> verifyPassword</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">password_hash</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">isValid</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">          },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> satisfies</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">        401</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // トークン生成（JWTのみ）</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">    const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> generateAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">    // レスポンスでJWTとユーザー情報を返す</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">          token</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;"> // JWT</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">            role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">          },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> satisfies</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> SuccessResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">      200</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> catch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">    console</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Login error:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INTERNAL_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン処理に失敗しました</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> satisfies</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">      500</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">};</span></span></code></pre></div><p><code>login.test.ts</code> は <code>login.ts</code>（<code>loginHandler</code>）の動作をテストしているファイルであり、Hono アプリケーションで <code>/api/login</code> エンドポイントに対する POST リクエストに対して、どのようなレスポンスが返るかを検証しています。</p><p>以下、それぞれのテストケースが <code>login.ts</code> 内のどの処理と対応しているかを <strong>処理ごと</strong> に丁寧に説明します。</p><hr><h2 id="🔹1-テスト-ログイン成功時に-jwt-とユーザー情報を返す" tabindex="-1">🔹1. テスト：ログイン成功時に JWT とユーザー情報を返す <a class="header-anchor" href="#🔹1-テスト-ログイン成功時に-jwt-とユーザー情報を返す" aria-label="Permalink to &quot;🔹1. テスト：ログイン成功時に JWT とユーザー情報を返す&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン成功時にJWTとユーザー情報を返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> ...</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><h3 id="対応する処理" tabindex="-1">対応する処理： <a class="header-anchor" href="#対応する処理" aria-label="Permalink to &quot;対応する処理：&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(email)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">first</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">&lt;...&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> isValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> verifyPassword</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">password_hash)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> generateAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> token</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> ...</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> },</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;"> 200</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><h3 id="ポイント" tabindex="-1">ポイント： <a class="header-anchor" href="#ポイント" aria-label="Permalink to &quot;ポイント：&quot;">​</a></h3><ul><li>テスト前に <code>verifyPassword</code> と <code>generateAuthToken</code> をモックして、それぞれ <code>&quot;true&quot;</code> と <code>&quot;mocked-jwt&quot;</code> を返すようにしている。</li><li>ダミーユーザー（<code>dummyUser</code>）をデータベースから取得できるように DB の <code>prepare().bind().first()</code> のチェーンをモックしている。</li><li>これにより <code>loginHandler</code> の中で <code>JWT</code> と <code>ユーザー情報</code> が生成され、HTTP 200 で返されることを確認。</li></ul><hr><p><code>login.test.ts</code> が <code>login.ts</code> に基づいてどのようにテストを行うのか、具体的に各処理ごとに説明します。</p><h2 id="🔹-1-テストケースのセットアップ-beforeeach" tabindex="-1">🔹 1. テストケースのセットアップ (<code>beforeEach</code>) <a class="header-anchor" href="#🔹-1-テストケースのセットアップ-beforeeach" aria-label="Permalink to &quot;🔹 1. テストケースのセットアップ (`beforeEach`)&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">beforeEach</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">restoreAllMocks</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // モック環境を設定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  env</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    ENVIRONMENT</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        bind</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">          first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">        }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    JWT_SECRET</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-secret</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    JWT_ISSUER</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-issuer</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    JWT_AUDIENCE</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">test-audience</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> unknown</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> Env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">  // モック関数を設定</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">authUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">verifyPassword</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#FF9CAC;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">authUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">generateAuthToken</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">mocked-jwt</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><p><code>beforeEach</code> は各テスト実行前に毎回実行されるセットアップ処理です。ここではテスト用のモック環境を作成しています。</p><ul><li><code>env.DB.prepare</code> や <code>authUtils.verifyPassword</code> などのモック関数が設定され、実際のデータベースや認証処理をシミュレートします。</li></ul></li></ul><h2 id="🔹-2-リクエスト作成-makerequest" tabindex="-1">🔹 2. リクエスト作成 (<code>makeRequest</code>) <a class="header-anchor" href="#🔹-2-リクエスト作成-makerequest" aria-label="Permalink to &quot;🔹 2. リクエスト作成 (`makeRequest`)&quot;">​</a></h2><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#EEFFFF;"> makeRequest</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> (</span><span style="--shiki-light:#E36209;--shiki-light-font-style:inherit;--shiki-dark:#EEFFFF;--shiki-dark-font-style:italic;">body</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> object</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  createRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">http://localhost/api/login</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    method</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">POST</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    body</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> JSON</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">stringify</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(body)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    headers</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#F07178;">Content-Type</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">application/json</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><code>makeRequest</code> は、テスト用にリクエストを作成するヘルパー関数です。リクエストの内容（ボディ）とヘッダーを設定して、<code>worker.fetch</code> に渡します。</li></ul><h2 id="🔹-3-ログイン成功のテスト" tabindex="-1">🔹 3. ログイン成功のテスト <a class="header-anchor" href="#🔹-3-ログイン成功のテスト" aria-label="Permalink to &quot;🔹 3. ログイン成功のテスト&quot;">​</a></h2><ul><li><strong>テストケース：</strong></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン成功時にJWTとユーザー情報を返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">password123</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> LoginSuccessResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">token</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">mocked-jwt</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">user</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toEqual</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><p><code>POST /api/login</code> に対して正しい <code>email</code> と <code>password</code> を含むリクエストを送信。</p></li><li><p><code>worker.fetch</code> によって <code>login.ts</code> の <code>loginHandler</code> が実行され、JWT とユーザー情報が正しく返されることを確認します。</p></li><li><p>ステータスコードが 200 であることと、レスポンス内のトークンおよびユーザー情報が期待通りであることを検証します。</p></li><li><p><strong>対応する処理：</strong></p></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// ユーザー情報をデータベースから取得</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">  &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">SELECT id, email, password_hash, name, role FROM users WHERE email = ?</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(email)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  .</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">&lt;{</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    id</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> number</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    password_hash</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    name</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#E36209;--shiki-dark:#F07178;">    role</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// パスワードを検証</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> isValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> verifyPassword</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">password_hash)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// JWTトークンの生成</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> token</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> generateAuthToken</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// レスポンスとしてトークンとユーザー情報を返す</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    data</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">      token</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">name</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">role</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">  200</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><h2 id="🔹-4-パスワード誤りのテスト" tabindex="-1">🔹 4. パスワード誤りのテスト <a class="header-anchor" href="#🔹-4-パスワード誤りのテスト" aria-label="Permalink to &quot;🔹 4. パスワード誤りのテスト&quot;">​</a></h2><ul><li><strong>テストケース：</strong></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">パスワードが間違っている場合、401エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">spyOn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">authUtils</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">verifyPassword</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#FF9CAC;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">wrongpassword</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><p>パスワードが間違っている場合、<code>verifyPassword</code> モック関数が <code>false</code> を返すようにして、<code>login.ts</code> が 401 エラーを返すことを確認します。</p></li><li><p>エラーメッセージが「メールアドレスまたはパスワードが正しくありません」であることを確認します。</p></li><li><p><strong>対応する処理：</strong></p></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// パスワード検証</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> isValid</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> verifyPassword</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">password_hash)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// パスワードが無効な場合、401エラーを返す</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">isValid) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">    401</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h2 id="🔹-5-ユーザーが存在しない場合のテスト" tabindex="-1">🔹 5. ユーザーが存在しない場合のテスト <a class="header-anchor" href="#🔹-5-ユーザーが存在しない場合のテスト" aria-label="Permalink to &quot;🔹 5. ユーザーが存在しない場合のテスト&quot;">​</a></h2><ul><li><strong>テストケース：</strong></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ユーザーが存在しない場合、401エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  (</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">prepare</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    bind</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockResolvedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#89DDFF;">null</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">no-user@example.com</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">whatever</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">401</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><p>存在しないユーザーがログインを試みると、<code>DB.prepare</code> のモックで <code>null</code> を返し、<code>login.ts</code> が 401 エラーを返すことを確認します。</p></li><li><p><strong>対応する処理：</strong></p></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// ユーザーがデータベースに存在しない場合</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">user) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INVALID_CREDENTIALS</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスまたはパスワードが正しくありません</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">    401</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h2 id="🔹-6-バリデーションエラーのテスト" tabindex="-1">🔹 6. バリデーションエラーのテスト <a class="header-anchor" href="#🔹-6-バリデーションエラーのテスト" aria-label="Permalink to &quot;🔹 6. バリデーションエラーのテスト&quot;">​</a></h2><ul><li><strong>テストケース：</strong></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">emailが入力されていない場合、400エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">password123</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">400</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">VALIDATION_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">    &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスとパスワードを正しく入力してください</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><p><code>email</code> がリクエストに含まれていない場合、<code>login.ts</code> は 400 エラーを返し、バリデーションエラーメッセージが正しいことを確認します。</p></li><li><p><strong>対応する処理：</strong></p></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// 入力値のバリデーション</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> validationResult</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> loginSchema</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">safeParse</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(rawJson)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// バリデーションエラーの場合</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">!</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">validationResult</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">success) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">VALIDATION_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">メールアドレスとパスワードを正しく入力してください</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">    400</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><h2 id="🔹-7-内部サーバーエラーのテスト" tabindex="-1">🔹 7. 内部サーバーエラーのテスト <a class="header-anchor" href="#🔹-7-内部サーバーエラーのテスト" aria-label="Permalink to &quot;🔹 7. 内部サーバーエラーのテスト&quot;">​</a></h2><ul><li><strong>テストケース：</strong></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">it</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">DBクエリが失敗した場合、500エラーを返す</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> async</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> ()</span><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;"> =&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  (</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">prepare</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    bind</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockReturnValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      first</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> vi</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fn</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">mockRejectedValue</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> Error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Database error</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">))</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> req</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;"> makeRequest</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> dummyUser</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">    password</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">password123</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">  }</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> worker</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">fetch</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">req</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#005CC5;--shiki-dark:#FFCB6B;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ExecutionContext</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> json</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;"> (</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()) </span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">as</span><span style="--shiki-light:#6F42C1;--shiki-dark:#FFCB6B;"> ErrorResponse</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">res</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">status</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">500</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">code</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INTERNAL_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">  expect</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">toBe</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン処理に失敗しました</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span></code></pre></div><ul><li><strong>対応する処理：</strong></li></ul><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light material-theme-darker vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-light-font-style:inherit;--shiki-dark:#545454;--shiki-dark-font-style:italic;">// データベースクエリの実行中にエラーが発生した場合</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C792EA;">  const</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;"> user</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;"> =</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">env</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#EEFFFF;">DB</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">bind</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">email</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">first</span><span style="--shiki-light:#D73A49;--shiki-dark:#89DDFF;">&lt;...&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;"> catch</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> (error) </span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;">  console</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">Login error:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> error</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-font-style:inherit;--shiki-dark:#89DDFF;--shiki-dark-font-style:italic;">  return</span><span style="--shiki-light:#24292E;--shiki-dark:#EEFFFF;"> c</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#82AAFF;">json</span><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">      error</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        code</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">INTERNAL_ERROR</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">        message</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;"> &quot;</span><span style="--shiki-light:#032F62;--shiki-dark:#C3E88D;">ログイン処理に失敗しました</span><span style="--shiki-light:#032F62;--shiki-dark:#89DDFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">      },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">    },</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#F78C6C;">    500</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#F07178;">  )</span><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#89DDFF;">}</span></span></code></pre></div><hr><ul><li>データベースクエリが失敗した場合、<code>login.ts</code> は 500 エラーを返し、内部サーバーエラーとして適切なメッセージが返されることを確認します。</li></ul><h3 id="結論-1" tabindex="-1">結論 <a class="header-anchor" href="#結論-1" aria-label="Permalink to &quot;結論&quot;">​</a></h3><p>各テストケースは <code>login.ts</code> の実際の処理を模倣し、特定のシナリオ（ログイン成功、パスワード誤り、ユーザー存在しない、バリデーションエラー、内部エラー）におけるレスポンスとエラーハンドリングを確認します。</p><p>理解しやすいように、テストケースごとに <code>login.ts</code> の対応処理を並べて説明します。</p><p>これで各テストケースに対応する処理を説明しました。それぞれのテストがどの部分に対応しているか、順番に確認できます。</p></div></div></main><footer class="VPDocFooter" data-v-ae40fa06 data-v-baa1eb86><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-baa1eb86><span class="visually-hidden" id="doc-footer-aria-label" data-v-baa1eb86>Pager</span><div class="pager" data-v-baa1eb86><a class="VPLink link pager-link prev" href="/small_ship/code/jesttest.html" data-v-baa1eb86><!--[--><span class="desc" data-v-baa1eb86>Previous page</span><span class="title" data-v-baa1eb86>テスト環境の設定</span><!--]--></a></div><div class="pager" data-v-baa1eb86><a class="VPLink link pager-link next" href="/small_ship/code/anzen.html" data-v-baa1eb86><!--[--><span class="desc" data-v-baa1eb86>Next page</span><span class="title" data-v-baa1eb86>.gitignore設定</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"about_api1.md\":\"DxOwZPP2\",\"about_api10.md\":\"CE7DX1Rm\",\"about_api11.md\":\"Drsh4aNm\",\"about_api2.md\":\"DP07qcgw\",\"about_api3.md\":\"Cd_4vlrS\",\"about_api4.md\":\"DcwdXXiO\",\"about_api5.md\":\"BwLQmR1X\",\"about_api6.md\":\"UOKIA3wf\",\"about_api7.md\":\"BQgXou4d\",\"about_api8.md\":\"BiKkyUNS\",\"about_api9.md\":\"CTRPDAy8\",\"about_cd1.md\":\"CVJRNNEl\",\"about_douki.md\":\"rO0Mg3VG\",\"about_index.md\":\"BG2ijgaU\",\"about_me.md\":\"Cz1U-opi\",\"about_tes1.md\":\"6KI1hVtn\",\"about_tes2.md\":\"XO847jvq\",\"about_tes3.md\":\"BzxSCWJ1\",\"about_tes4.md\":\"Cj8-GF9r\",\"about_tes5.md\":\"BZYAeCXG\",\"about_tes6.md\":\"CL2Dsxsb\",\"code_anzen.md\":\"ys8Tjya6\",\"code_bk_kankyou.md\":\"DTemP2aI\",\"code_css.md\":\"D5dCrOxH\",\"code_deburoi.md\":\"DPx6efZ1\",\"code_github.md\":\"Dr0EIbzd\",\"code_github_set.md\":\"CSZ72otl\",\"code_index.md\":\"BjgUNwH-\",\"code_jesttest.md\":\"B-KpKN3e\",\"code_kankyou.md\":\"HvNIZVfk\",\"code_route.md\":\"DoG-TBPB\",\"code_setting.md\":\"CuLkc6q8\",\"code_v_kankyou.md\":\"CPfcC-l5\",\"code_vitest.md\":\"CQ_K4J4X\",\"coment_001.md\":\"CqH1IUrO\",\"coment_002.md\":\"C6euWyAR\",\"coment_003.md\":\"1Zclh7lg\",\"coment_004.md\":\"BssTalQY\",\"coment_005.md\":\"DkPc8Zc5\",\"coment_006.md\":\"BYFmrvY5\",\"coment_007.md\":\"DOoheWjn\",\"coment_008.md\":\"DM_9xNhI\",\"coment_009.md\":\"BYrk3U_9\",\"coment_auth.md\":\"ExYeKLBQ\",\"coment_groball_c.md\":\"6RC8wW5m\",\"coment_index.md\":\"CNd65Gw5\",\"coment_jwtmiddleware.md\":\"Cvj3vwgk\",\"coment_mememe.md\":\"BNyXGkDM\",\"coment_navber.md\":\"Mw8_96Kf\",\"coment_routes.md\":\"DBWH3a6Q\",\"coment_storage.md\":\"DJe0FySj\",\"coment_type.md\":\"CkXZmnYU\",\"coment_vercel_json.md\":\"NN47x0BS\",\"coment_worker.md\":\"Dv2MQ4Y_\",\"guide_admin.md\":\"De7Lzzj8\",\"guide_admin1.md\":\"CEPKbi7q\",\"guide_api1.md\":\"DNIGwzeg\",\"guide_api1_copi.md\":\"xhGORltG\",\"guide_api1_sekei.md\":\"C_IDYBwa\",\"guide_api1plan.md\":\"DIv1owKv\",\"guide_api1test.md\":\"Dfc_7dfP\",\"guide_auth_provider.md\":\"IC2rnFBp\",\"guide_auth_provider2.md\":\"CtiLuhGQ\",\"guide_auth_provider3.md\":\"Cb-VSntM\",\"guide_auth_provider4.md\":\"DrRaFgby\",\"guide_auth_provider5.md\":\"BIqPr3wl\",\"guide_auth_provider6.md\":\"DNCAPQTU\",\"guide_dashboard.md\":\"B4P03QKa\",\"guide_groball.md\":\"DyCZggpv\",\"guide_index.md\":\"CzpegpNw\",\"guide_jwt_ns.md\":\"Clh-gNIY\",\"guide_keikaku2.md\":\"B3oikMwl\",\"guide_keikaku3.md\":\"BesTZcDu\",\"guide_keikaku3_1.md\":\"DthISx0q\",\"guide_keikaku4.md\":\"cbXft2Sr\",\"guide_keikaku5.md\":\"DS5IZyWZ\",\"guide_keikaku6.md\":\"C8ApjEIF\",\"guide_keikaku7.md\":\"B33z2G3y\",\"guide_kekaku1.md\":\"BFliptO1\",\"guide_login.md\":\"xz-peXtg\",\"guide_member1.md\":\"DWK69umB\",\"guide_nb.md\":\"CXwwET9A\",\"guide_nb2.md\":\"B1cZwrnq\",\"guide_pr_list.md\":\"BoPXpGCw\",\"guide_register.md\":\"B2UGkJfX\",\"guide_tools.md\":\"DmsQB6ux\",\"index.md\":\"DRvbQORx\",\"posts_css.md\":\"BXmoasYw\",\"posts_hello-react.md\":\"B6Ny2ff-\",\"posts_index.md\":\"DBcvpvzH\",\"posts_memo.md\":\"7k7Q8wjY\",\"tutorial_cg2.md\":\"DtaasOJB\",\"tutorial_cgzo.md\":\"Bwv9bpPw\",\"tutorial_dc2.md\":\"mVTrCneq\",\"tutorial_dcr1.md\":\"BU_RHb40\",\"tutorial_dcv3.md\":\"BRJsbNFd\",\"tutorial_index.md\":\"CSV0gfXL\",\"tutorial_memeomeimo.md\":\"CIG5RMig\",\"tutorial_memo2.md\":\"ttG0HGOV\",\"tutorial_memo3.md\":\"Def1jAR7\",\"tutorial_memo3_2.md\":\"D3PdSRgs\",\"tutorial_memo4.md\":\"B0CbO6N4\",\"tutorial_memo5.md\":\"ZEynM23v\",\"tutorial_nextjs-project.md\":\"CRxqVUd5\",\"tutorial_react-basics.md\":\"CE3rqkhK\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"ja-JP\",\"dir\":\"ltr\",\"title\":\"Kaikyou の開発ノート\",\"description\":\"React / Next.js / Cloudflare D1 を中心にした開発ブログ\",\"base\":\"/small_ship/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"🏠 ホーム\",\"link\":\"/\"},{\"text\":\"📚 ガイド\",\"link\":\"/guide/\"},{\"text\":\"🛠️ チュートリアル\",\"link\":\"/tutorial/\"},{\"text\":\"📒 記事一覧\",\"link\":\"/posts/\"},{\"text\":\"👤 私について\",\"link\":\"/about/me\"},{\"text\":\"📒 設定について\",\"link\":\"/code/\"},{\"text\":\"📒 説明\",\"link\":\"/coment/\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"要件定義\",\"collapsed\":false,\"items\":[{\"text\":\"001-プロジェクトセットアップ\",\"link\":\"/guide/kekaku1\"},{\"text\":\"推奨パッケージ一覧\",\"link\":\"/guide/tools\"}]},{\"text\":\"設計\",\"collapsed\":false,\"items\":[{\"text\":\"003-1_設計-要件\",\"link\":\"/guide/keikaku3_1\"},{\"text\":\"003-2_設計-基本\",\"link\":\"/guide/keikaku3\"}]},{\"text\":\"frontend開発\",\"collapsed\":false,\"items\":[{\"text\":\"商品一覧\",\"link\":\"/guide/pr_list\"},{\"text\":\"ナビゲーション1.0\",\"link\":\"/guide/nb\"},{\"text\":\"ナビゲーション2.0\",\"link\":\"/guide/nb2\"},{\"text\":\"登録\",\"link\":\"/guide/register\"},{\"text\":\"ログイン\",\"link\":\"/guide/login\"},{\"text\":\"JWT認証開発\",\"link\":\"/guide/jwt_ns\"},{\"text\":\"グローバル状態管理凡例\",\"link\":\"/guide/groball\"},{\"text\":\"状態管理AuthProvider1.0\",\"link\":\"/guide/auth_provider\"},{\"text\":\"状態管理AuthProvider2.0\",\"link\":\"/guide/auth_provider2\"},{\"text\":\"状態管理AuthProvider3.0\",\"link\":\"/guide/auth_provider3\"},{\"text\":\"状態管理AuthProvider4.0\",\"link\":\"/guide/auth_provider4\"},{\"text\":\"状態管理AuthProviderバッグ修正\",\"link\":\"/guide/auth_provider5\"},{\"text\":\"ダッシュボード（管理画面）\",\"link\":\"/guide/dashboard\"},{\"text\":\"会員管理画面1.0\",\"link\":\"/guide/member1\"},{\"text\":\"管理者管理画面1.0\",\"link\":\"/guide/admin1\"}]},{\"text\":\"backend開発\",\"collapsed\":false,\"items\":[{\"text\":\"004-D1データベース作成\",\"link\":\"/guide/keikaku4\"},{\"text\":\"005-フロントとバックエンドの連携\",\"link\":\"/guide/keikaku5\"},{\"text\":\"1. 🔐 認証系API開発\",\"link\":\"/guide/api1\"},{\"text\":\"api作成\",\"link\":\"/guide/api2\"},{\"text\":\"api作成\",\"link\":\"/guide/api3\"},{\"text\":\"api作成\",\"link\":\"/guide/api4\"},{\"text\":\"api作成\",\"link\":\"/guide/api5\"},{\"text\":\"api作成\",\"link\":\"/guide/api6\"},{\"text\":\"api作成\",\"link\":\"/guide/api7\"},{\"text\":\"api作成\",\"link\":\"/guide/api8\"},{\"text\":\"api作成\",\"link\":\"/guide/api9\"},{\"text\":\"api作成\",\"link\":\"/guide/api10\"},{\"text\":\"api作成\",\"link\":\"/guide/api11\"}]},{\"text\":\"単体テスト\",\"collapsed\":false,\"items\":[{\"text\":\"0. 🔐 APIテスト設計簡略版\",\"link\":\"/guide/api1_sekei\"},{\"text\":\"0. 🔐 APIテストコピペ\",\"link\":\"/guide/api1_copi\"},{\"text\":\"1. 🔐 認証系API_登録・ログイン\",\"link\":\"/guide/api1plan\"},{\"text\":\"1. 🔐 認証系API_ログアウト\",\"link\":\"/guide/api1test\"},{\"text\":\"api作成\",\"link\":\"/guide/api2\"},{\"text\":\"api作成\",\"link\":\"/guide/api3\"},{\"text\":\"api作成\",\"link\":\"/guide/api4\"},{\"text\":\"api作成\",\"link\":\"/guide/api5\"},{\"text\":\"api作成\",\"link\":\"/guide/api6\"},{\"text\":\"api作成\",\"link\":\"/guide/api7\"},{\"text\":\"api作成\",\"link\":\"/guide/api8\"},{\"text\":\"api作成\",\"link\":\"/guide/api9\"},{\"text\":\"api作成\",\"link\":\"/guide/api10\"},{\"text\":\"api作成\",\"link\":\"/guide/api11\"}]},{\"text\":\"その他\",\"collapsed\":true,\"items\":[{\"text\":\"使い方ガイド\",\"link\":\"/guide/\"},{\"text\":\"破棄予定002-基本ページの作成\",\"link\":\"/guide/keikaku2\"},{\"text\":\"006-RestAPIの開発\",\"link\":\"/guide/keikaku6\"},{\"text\":\"007-RestAPIのバージョンアップ\",\"link\":\"/guide/keikaku7\"},{\"text\":\"工作目标\",\"link\":\"/posts/memo\"},{\"text\":\"Next.js购物网站开发\",\"link\":\"/posts/hello-react\"}]}],\"/tutorial/\":[{\"text\":\"チュートリアル\",\"collapsed\":true,\"items\":[{\"text\":\"DC-001\",\"link\":\"/tutorial/react-basics\"},{\"text\":\"CG-001\",\"link\":\"/tutorial/nextjs-project\"},{\"text\":\"DC-002\",\"link\":\"/tutorial/dc2\"},{\"text\":\"cg-002\",\"link\":\"/tutorial/cg2\"},{\"text\":\"メモ―\",\"link\":\"/tutorial/memeomeimo\"},{\"text\":\"メモ―2\",\"link\":\"/tutorial/memo2\"},{\"text\":\"メモ―3\",\"link\":\"/tutorial/memo3\"},{\"text\":\"メモ―3追加女神\",\"link\":\"/tutorial/memo3_2\"},{\"text\":\"メモ―4\",\"link\":\"/tutorial/memo4\"},{\"text\":\"天坑水库监狱\",\"link\":\"/tutorial/memo5\"},{\"text\":\"DeekSeek-R1\",\"link\":\"/tutorial/dcr1\"},{\"text\":\"DeekSeek-V3\",\"link\":\"/tutorial/dcv3\"},{\"text\":\"chatGPT-Zo\",\"link\":\"/tutorial/cgzo\"}]}],\"/posts/\":[{\"text\":\"記事\",\"collapsed\":true,\"items\":[{\"text\":\"ゴール\",\"link\":\"/posts/memo\"},{\"text\":\"Next.js で買い物サイトを作る\",\"link\":\"/posts/hello-react\"}]},{\"text\":\"映画\",\"collapsed\":true,\"items\":[{\"text\":\"ゴール\",\"link\":\"/posts/memo\"},{\"text\":\"Tailwind CSSセットアップ\",\"link\":\"/posts/css\"}]}],\"/about/\":[{\"text\":\"私について\",\"collapsed\":true,\"items\":[{\"text\":\"プロフィール\",\"link\":\"/about/me\"},{\"text\":\"ブログの歴史\",\"link\":\"/about/history\"},{\"text\":\"Cloudflare本番D1作成\",\"link\":\"/about/cd1\"},{\"text\":\"中レベルAPI設計\",\"link\":\"/about/tes1\"},{\"text\":\"高レベルAPI設計\",\"link\":\"/about/tes2\"},{\"text\":\"中高レベルAPI設計の採点\",\"link\":\"/about/tes3\"},{\"text\":\"chatGPT開発流れ説明\",\"link\":\"/about/tes4\"},{\"text\":\"DeepSeek V3 テーブル説明\",\"link\":\"/about/tes6\"},{\"text\":\"DeepSeek R1 テーブル説明\",\"link\":\"/about/tes5\"},{\"text\":\"ローカル開発とクラウド同期\",\"link\":\"/about/douki\"},{\"text\":\"1. 🔐 認証系API開発\",\"link\":\"/about/api1\"},{\"text\":\"2. 👤 ユーザー管理API開発\",\"link\":\"/about/api2\"},{\"text\":\"3. 🛒 商品（Products）API開発\",\"link\":\"/about/api3\"},{\"text\":\"4. 🖼️ 商品画像API開発\",\"link\":\"/about/api4\"},{\"text\":\"5. 🏷️ タグAPI開発\",\"link\":\"/about/api5\"},{\"text\":\"6. 📂 カテゴリAPI開発\",\"link\":\"/about/api6\"},{\"text\":\"7. 🛍️ カートAPI開発\",\"link\":\"/about/api7\"},{\"text\":\"8. 📦 注文API開発\",\"link\":\"/about/api8\"},{\"text\":\"9. ✍️ レビューAPI開発\",\"link\":\"/about/api9\"},{\"text\":\"10. 💖 お気に入りAPI開発\",\"link\":\"/about/api10\"},{\"text\":\"11. 📝 管理ログ（Admin Logs）API開発\",\"link\":\"/about/api11\"}]}],\"/code/\":[{\"text\":\"フロントエンド設定\",\"collapsed\":false,\"items\":[{\"text\":\"環境変数設定ファイル\",\"link\":\"/code/kankyou\"},{\"text\":\"Tailwind CSSセットアップ\",\"link\":\"/code/css\"}]},{\"text\":\"バックエンド設定\",\"collapsed\":false,\"items\":[{\"text\":\"（Cloudflare Workers）設定\",\"link\":\"/code/setting\"},{\"text\":\"環境変数設定\",\"link\":\"/code/bk_kankyou\"},{\"text\":\"バックエンドルート設定\",\"link\":\"/code/route\"},{\"text\":\"テスト環境の設定\",\"link\":\"/code/jesttest\"},{\"text\":\"Vitestテスト環境の設定\",\"link\":\"/code/vitest\"}]},{\"text\":\"プロジェクト設定\",\"collapsed\":false,\"items\":[{\"text\":\".gitignore設定\",\"link\":\"/code/anzen\"},{\"text\":\"修正内容デプロイ手順\",\"link\":\"/code/deburoi\"},{\"text\":\"Vercel環境変数設定\",\"link\":\"/code/v_kankyou\"},{\"text\":\"githubセットアップ\",\"link\":\"/code/github_set\"},{\"text\":\"壊れた環境の復元\",\"link\":\"/code/github\"}]}],\"/coment/\":[{\"text\":\"バックエンド説明\",\"collapsed\":false,\"items\":[{\"text\":\"メモ帳領域王国入国禁止 \",\"link\":\"/coment/mememe\"},{\"text\":\"型定義 \",\"link\":\"/coment/type\"},{\"text\":\"ミドルウェア \",\"link\":\"/coment/jwtmiddleware\"},{\"text\":\"認証関連ユーティリティ\",\"link\":\"/coment/auth\"},{\"text\":\"storage \",\"link\":\"/coment/storage\"},{\"text\":\"worker\",\"link\":\"/coment/worker\"},{\"text\":\"ルート集約\",\"link\":\"/coment/routes\"},{\"text\":\"registerHandler\",\"link\":\"/coment/001\"},{\"text\":\"loginHandler★★★★★\",\"link\":\"/coment/002\"},{\"text\":\"getUserHandler\",\"link\":\"/coment/003\"},{\"text\":\"logoutHandler\",\"link\":\"/coment/004\"},{\"text\":\"meHandler\",\"link\":\"/coment/005\"},{\"text\":\"productPostHandler\",\"link\":\"/coment/006\"},{\"text\":\"productGetHandler\",\"link\":\"/coment/007\"},{\"text\":\"productGetByIdHandler\",\"link\":\"/coment/008\"},{\"text\":\"getCartHandler\",\"link\":\"/coment/009\"}]},{\"text\":\"フロントエンド説明\",\"collapsed\":false,\"items\":[{\"text\":\"NavBar.tsx\",\"link\":\"/coment/navber\"},{\"text\":\"グローバル状態管理\",\"link\":\"/coment/groball_c\"}]},{\"text\":\"プロジェクト設定\",\"collapsed\":false,\"items\":[{\"text\":\"vercel.json\",\"link\":\"/coment/vercel_json\"}]}]},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/your-account\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false}");</script>
    
  </body>
</html>